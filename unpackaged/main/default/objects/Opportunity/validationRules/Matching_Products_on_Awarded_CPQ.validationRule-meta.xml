<?xml version="1.0" encoding="utf-8"?>
<ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Matching_Products_on_Awarded_CPQ</fullName>
    <active>true</active>
    <description>Ensures that when an opportunity is Awarded or Lost that it has the right products attached.  For Non-CPQ only

NOTE: If more Record Types are added, this(and the Roll Up fields it depends on), will need to be updated.</description>
    <errorConditionFormula>AND(
$User.Username &lt;&gt;'rgali@blackdiamondgroup.com',
$User.Username  &lt;&gt; 'ithelpdesk@blackdiamondgroup.com',
$User.Username  &lt;&gt; 'salesforcedatamigration@blackdiamondgroup.com',
      RecordType.Name &lt;&gt; "Vanguard",
      RecordType.Name &lt;&gt; "BD BOXX CPQ",
      RecordType.Name &lt;&gt; "BD ES CPQ", 
      RecordType.Name &lt;&gt; "BD AUS CPQ", 
      RecordType.Name &lt;&gt; "BD WFS CPQ",
      RecordType.Name &lt;&gt; "BD MSS",
      RecordType.Name &lt;&gt; "BD Modular",
      RecordType.Name &lt;&gt; "BD MSS Major Projects",
      RecordType.Name &lt;&gt; "BD Energy",
      RecordType.Name &lt;&gt; "BD Workforce",
      RecordType.Name &lt;&gt; "BD Lodging", 
      RecordType.Name &lt;&gt; "BD Disaster",
    OR(
        CONTAINS(
            TEXT(StageName),
            "Awarded"
        ),
        CONTAINS(
            TEXT(StageName),
            "Lost"    
        ),
        CONTAINS(
            TEXT(StageName),
            "WIP" )
    ),

    OR(
        IF(INCLUDES(Transaction_Type__c, "Rental"),
            ProductCount_Rental__c &lt;= 0,
            ProductCount_Rental__c &gt; 0
        ),
        IF(INCLUDES(Transaction_Type__c,"Sale"),
            ProductCount_Sale__c &lt;= 0,
            ProductCount_Sale__c &gt; 0
        ),
        IF(INCLUDES(Transaction_Type__c,"Operations"),
            ProductCount_Operations__c &lt;= 0,
            ProductCount_Operations__c &gt; 0
        ),
        IF(INCLUDES(Transaction_Type__c,"Recurring Non-Rental"),
            ProductCount_Sublease__c &lt;= 0,
            ProductCount_Sublease__c &gt; 0 
        ),
        IF(INCLUDES(Transaction_Type__c,"Lodging"),
            ProductCount_Lodging__c &lt;= 0,
            ProductCount_Lodging__c &gt; 0
        )
    )
)</errorConditionFormula>
    <errorMessage>Before the opportunity can be "Awarded" or "Lost"; please attach the necessary products to match the selected fields in Transaction Type.</errorMessage>
</ValidationRule>
